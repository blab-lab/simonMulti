
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

set.seed(444) #Set up random seed for reproducibility

options(scipen = 999) #Turn off scientific expressions

library(tidyverse)
library(ggpubr)

library(qdapTools)

library(lme4)
library(lmerTest)
library(buildmer)

library(phia)

library(MuMIn)
library(r2glmm)

library(effsize)

rm(list=ls()) #Clear environment
```

#Normalization

```{r}
data1 <- read.csv("//wcs-cifs/wc/smng/experiments/simonMultisyllable/acousticdata/R_Zyy/Manuscript/F1_Exp1_S1.csv")

data1 <- unique(data1)

#Add Chunk info

var1 <- length(unique(data1$Word)) * 10

data1$Chunk <- ceiling(data1$Trial/var1)

#Obtain Baseline means

temp1 <- aggregate(data1$meanF1_mel, 
                   list(data1$Direction, data1$Chunk, data1$Speaker), 
                   FUN = mean) 

colnames(temp1) <- c("Direction", "Chunk", "Speaker", "meanF1")

#Limit results to the last 10 trials of Baseline 

temp2 <- data.frame(table(data1$Chunk, data1$Phase))
temp2 <- temp2[which(temp2$Freq != 0 & temp2$Var2 == "Baseline"),]
var1 <- max(as.numeric(as.character(temp2$Var1)))


temp1 <- temp1[which(temp1$Chunk == var1), ]

temp1$Tracer <- paste(temp1$Speaker, temp1$Direction, sep = "_")
data1$Tracer <- paste(data1$Speaker, data1$Direction, sep = "_")

#Pairing data from temp1 

data1$F1_Baseline <- lookup(terms = data1$Tracer, 
                            key.match = temp1$Tracer,
                            key.reassign = temp1$meanF1)

#Calculate F1 change 

data1$F1_Change <- data1$meanF1_mel - data1$F1_Baseline
```

```{r}
#Add frequency

data1$Lexical <- ifelse(data1$Word == "head", log10(0.0385950698/100), 
                        ifelse(data1$Word == "bed", log(0.0127859079/100), log(0.0000305076/100)))

table(data1$Lexical, data1$Word)

#Add Block info

var1 <- max(data1$Trial)
var2 <- max(data1$Trial)/length(unique(data1$Word))

temp1 <- seq(from = 1, to = var1, by = 1)

temp2 <- rep(1:var2, each = length(unique(data1$Word)), length.out = var1)

temp1 <- data.frame(temp1, temp2)

colnames(temp1) <- c("Trial", "Block")

#Pair
data1$Block <- lookup(terms = data1$Trial,
                      key.match = temp1$Trial,
                      key.reassign = temp1$Block)

save.image("Exp1.RData")
```




#Model fit

```{r}
#Restrict to the interested areas

head(data1)

data11 <- data1[which(data1$Chunk %in% c(13, 16)), ]

data11$Phase <- factor(data11$Phase)

contrasts(data11$Phase) = contr.sum(2)

contrasts(data11$Phase)

data11$Direction <- factor(data11$Direction)

contrasts(data11$Direction) = contr.sum(3)

contrasts(data11$Direction)

f0 <- F1_Change ~ Direction * Phase * Lexical + 
  (Direction * Phase | Speaker) 

m.order <- buildmer(f0,
                    data = data11,
                    buildmerControl=buildmerControl(direction = "order",
                                                    crit = "BIC", 
                                                    args=list(control=lmerControl(optimizer='bobyqa'))))

(f1 <- formula(m.order@model))

m.backward <- buildmer(f1,
                       data = data11,
                       buildmerControl=list(direction = "backward",
                                            crit = "BIC", 
                                            args=list(control=lmerControl(optimizer='bobyqa'))))

summary(m.backward)

(f2 <- formula(m.backward@model))
```

```{r}
m1 <- lmer(f2,
           data = data11,
           control = lmerControl(optimizer = "bobyqa",
                                 optCtrl = list(maxfun = 2e5)),
           REML = TRUE)

car::Anova(m1, type = 3)

#Post-hoc

testInteractions(m1, 
                 pairwise = c("Direction"))

testInteractions(m1, 
                 fixed = c("Direction"))
```

```{r}
#SE

aggregate(data11$F1_Change,
          list(data11$Direction), 
                   FUN = plotrix::std.error) 

#Effect size

r2beta(m1, partial = TRUE, 
       method = "nsj")
```

```{r}
#Cohen's d, Direction

temp1 <- data11[which(data11$Direction == "Upshift"), "F1_Change"]
temp2 <- data11[which(data11$Direction == "Downshift"), "F1_Change"]

cohen.d(temp1, temp2)
```

#Test the Baseline difference

```{r}
#S1

temp1 <- data1[which(data1$Phase == "Baseline"), ]

temp1 <- temp1[which(temp1$Direction != "Unshifted"), ]

temp1 <- temp1[which(temp1$Chunk == 3), ]

f0 <- meanF1_mel ~ Word + 
  (Word| Speaker)

m.order <- buildmer(f1,
                    data = temp1,
                    buildmerControl=buildmerControl(direction = "order",
                                                    crit = "BIC", 
                                                    args=list(control=lmerControl(optimizer='bobyqa'))))

(f1 <- formula(m.order@model))

m.backward <- buildmer(f1,
                       data = temp1,
                       buildmerControl=list(direction = "backward",
                                            crit = "BIC", 
                                            args=list(control=lmerControl(optimizer='bobyqa'))))

summary(m.backward)

(f <- formula(m.backward@model))

#meanF1_mel ~ 1 + (1 | Speaker)

```

```{r}

```
